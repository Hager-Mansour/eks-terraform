name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: aws-credentials # Must contain AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
  - name: terraform_version
    value: '1.5.0'
  - name: aws_region
    value: 'us-east-1'
  - name: s3_bucket
    value: 'my-terraform-state-bucket' # REPLACE with your actual S3 bucket name
  - name: s3_key
    value: 'eks-cluster/terraform.tfstate'
  - name: dynamodb_lock_table
    value: 'eks-demo-table'

jobs:
  - job: DeployInfrastructure
    displayName: 'Terraform Init, Plan, Apply'
    steps:
      - task: TerraformInstaller@1
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: '$(terraform_version)'

      - script: |
          terraform init \
            -backend-config="bucket=$(s3_bucket)" \
            -backend-config="key=$(s3_key)" \
            -backend-config="region=$(aws_region)" \
            -backend-config="dynamodb_table=$(dynamodb_lock_table)"
        displayName: 'Terraform Init'
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

      - script: terraform plan -out=tfplan -input=false
        displayName: 'Terraform Plan'
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_DEFAULT_REGION: $(aws_region)

      - script: terraform apply -input=false tfplan
        displayName: 'Terraform Apply'
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_DEFAULT_REGION: $(aws_region)